version: '3.8'

services:
  ragfab-thumbs-down-worker:
    build:
      context: ../..
      dockerfile: web-api/Dockerfile
    container_name: ragfab-thumbs-down-worker
    command: python -m app.thumbs_down_worker
    environment:
      # Database connection
      DATABASE_URL: ${DATABASE_URL:-postgresql://raguser:ragpass@ragfab-postgres.internal:5432/ragdb}

      # Generic LLM Configuration (Chocolatine par défaut)
      LLM_API_URL: ${LLM_API_URL:-https://apigpt.mynumih.fr}
      LLM_API_KEY: ${LLM_API_KEY:-}
      LLM_MODEL_NAME: ${LLM_MODEL_NAME:-jpacifico/Chocolatine-2-14B-Instruct-v2.0.3}
      LLM_USE_TOOLS: ${LLM_USE_TOOLS:-false}
      LLM_TIMEOUT: ${LLM_TIMEOUT:-120.0}

      # Legacy variables for backward compatibility
      CHOCOLATINE_API_URL: ${CHOCOLATINE_API_URL:-https://apigpt.mynumih.fr}
      CHOCOLATINE_API_KEY: ${CHOCOLATINE_API_KEY:-}
      CHOCOLATINE_MODEL_NAME: ${CHOCOLATINE_MODEL_NAME:-jpacifico/Chocolatine-2-14B-Instruct-v2.0.3}

      # Thumbs Down Configuration
      THUMBS_DOWN_AUTO_ANALYSIS: ${THUMBS_DOWN_AUTO_ANALYSIS:-true}
      THUMBS_DOWN_CONFIDENCE_THRESHOLD: ${THUMBS_DOWN_CONFIDENCE_THRESHOLD:-0.7}
      THUMBS_DOWN_LLM_PROVIDER: ${THUMBS_DOWN_LLM_PROVIDER:-chocolatine}
      THUMBS_DOWN_AUTO_NOTIFICATIONS: ${THUMBS_DOWN_AUTO_NOTIFICATIONS:-true}

      # Logs
      LOG_LEVEL: ${LOG_LEVEL:-INFO}

    restart: unless-stopped

    # Limites de ressources (thumbs-down worker est léger)
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

    # Healthcheck (vérifie que le worker est actif)
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    networks:
      - coolify

networks:
  coolify:
    external: true
    name: coolify
