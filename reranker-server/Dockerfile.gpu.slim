# Dockerfile GPU optimisé pour service reranker avec PyTorch pré-installé
# Utilise l'image officielle NVIDIA PyTorch pour éviter de télécharger 2.2 GB pendant le build
FROM nvcr.io/nvidia/pytorch:24.01-py3

# Variables d'environnement
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    CUDA_VISIBLE_DEVICES=0

# Installer curl pour healthcheck
RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*

# Créer utilisateur non-root
RUN useradd -m -u 1000 reranker && \
    mkdir -p /app && \
    chown -R reranker:reranker /app

WORKDIR /app

# Copier requirements (sans torch car déjà dans l'image de base)
COPY requirements.txt .

# Installer uniquement les dépendances manquantes (PyTorch déjà présent)
RUN pip install --no-cache-dir \
    fastapi \
    uvicorn[standard] \
    sentence-transformers \
    pydantic-settings

# Copier code application
COPY app.py .

USER reranker

EXPOSE 8002

HEALTHCHECK --interval=30s --timeout=10s --start-period=90s --retries=3 \
    CMD curl -f http://localhost:8002/health || exit 1

CMD ["uvicorn", "app:app", "--host", "0.0.0.0", "--port", "8002", "--workers", "1"]
